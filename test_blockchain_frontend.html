<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔗 Blockchain API Test Dashboard</h1>
    
    <div class="container">
        <h2>📊 Backend Status</h2>
        <div id="backend-status" class="loading">Checking backend status...</div>
        <button class="refresh-btn" onclick="checkBackendStatus()">Refresh Status</button>
    </div>
    
    <div class="container">
        <h2>📈 Blockchain Statistics</h2>
        <div id="blockchain-stats" class="loading">Loading blockchain statistics...</div>
        <button class="refresh-btn" onclick="loadBlockchainStats()">Refresh Stats</button>
    </div>
    
    <div class="container">
        <h2>🧱 Recent Blocks</h2>
        <div id="blocks-data" class="loading">Loading blocks data...</div>
        <button class="refresh-btn" onclick="loadBlocksData()">Refresh Blocks</button>
    </div>
    
    <div class="container">
        <h2>💱 Recent Transactions</h2>
        <div id="transactions-data" class="loading">Loading transactions data...</div>
        <button class="refresh-btn" onclick="loadTransactionsData()">Refresh Transactions</button>
    </div>
    
    <div class="container">
        <h2>📋 Contract Events</h2>
        <div id="events-data" class="loading">Loading events data...</div>
        <button class="refresh-btn" onclick="loadEventsData()">Refresh Events</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8001';
        
        // 检查后端状态
        async function checkBackendStatus() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<div class="loading">Checking backend status...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <strong>✅ Backend is healthy!</strong><br>
                            API Status: ${data.services.api}<br>
                            Blockchain Status: ${data.services.blockchain}<br>
                            Network ID: ${data.blockchain_details.network_id}<br>
                            Latest Block: ${data.blockchain_details.latest_block}<br>
                            Contracts Connected: ${data.blockchain_details.contracts.agent_registry ? '✅' : '❌'} AgentRegistry, 
                            ${data.blockchain_details.contracts.task_manager ? '✅' : '❌'} TaskManager, 
                            ${data.blockchain_details.contracts.learning ? '✅' : '❌'} Learning
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="status error">❌ Backend is unhealthy: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ Failed to connect to backend: ${error.message}</div>`;
            }
        }
        
        // 加载区块链统计数据
        async function loadBlockchainStats() {
            const statsDiv = document.getElementById('blockchain-stats');
            statsDiv.innerHTML = '<div class="loading">Loading blockchain statistics...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/blockchain/stats`);
                const data = await response.json();
                
                statsDiv.innerHTML = `
                    <div class="status success">
                        <strong>📊 Blockchain Statistics</strong>
                        <table class="data-table">
                            <tr><th>Metric</th><th>Value</th></tr>
                            <tr><td>Connected</td><td>${data.connected ? '✅ Yes' : '❌ No'}</td></tr>
                            <tr><td>Latest Block</td><td>#${data.latest_block}</td></tr>
                            <tr><td>Block Count</td><td>${data.block_count}</td></tr>
                            <tr><td>Transaction Count</td><td>${data.transaction_count}</td></tr>
                            <tr><td>Avg Block Time</td><td>${data.avg_block_time}s</td></tr>
                            <tr><td>Avg Transactions/Block</td><td>${data.avg_transactions_per_block}</td></tr>
                            <tr><td>Agent Count</td><td>${data.agent_count}</td></tr>
                            <tr><td>Task Count</td><td>${data.task_count}</td></tr>
                            <tr><td>Learning Events</td><td>${data.learning_event_count}</td></tr>
                        </table>
                    </div>
                `;
            } catch (error) {
                statsDiv.innerHTML = `<div class="status error">❌ Failed to load blockchain stats: ${error.message}</div>`;
            }
        }
        
        // 加载区块数据
        async function loadBlocksData() {
            const blocksDiv = document.getElementById('blocks-data');
            blocksDiv.innerHTML = '<div class="loading">Loading blocks data...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/blockchain/blocks?limit=5`);
                const data = await response.json();
                
                if (data.blocks && data.blocks.length > 0) {
                    let tableHTML = `
                        <div class="status success">
                            <strong>🧱 Recent Blocks (${data.total} total)</strong>
                            <table class="data-table">
                                <tr>
                                    <th>Block #</th>
                                    <th>Hash</th>
                                    <th>Timestamp</th>
                                    <th>Transactions</th>
                                    <th>Gas Used</th>
                                    <th>Miner</th>
                                </tr>
                    `;
                    
                    data.blocks.forEach(block => {
                        const timestamp = new Date(block.timestamp * 1000).toLocaleString();
                        const shortHash = block.hash.substring(0, 10) + '...';
                        const shortMiner = block.miner.substring(0, 10) + '...';
                        
                        tableHTML += `
                            <tr>
                                <td>${block.number}</td>
                                <td title="${block.hash}">${shortHash}</td>
                                <td>${timestamp}</td>
                                <td>${block.transactions}</td>
                                <td>${block.gas_used.toLocaleString()}</td>
                                <td title="${block.miner}">${shortMiner}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</table></div>';
                    blocksDiv.innerHTML = tableHTML;
                } else {
                    blocksDiv.innerHTML = '<div class="status error">No blocks found</div>';
                }
            } catch (error) {
                blocksDiv.innerHTML = `<div class="status error">❌ Failed to load blocks: ${error.message}</div>`;
            }
        }
        
        // 加载交易数据
        async function loadTransactionsData() {
            const txDiv = document.getElementById('transactions-data');
            txDiv.innerHTML = '<div class="loading">Loading transactions data...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/blockchain/transactions?limit=3`);
                const data = await response.json();
                
                if (data.transactions && data.transactions.length > 0) {
                    let tableHTML = `
                        <div class="status success">
                            <strong>💱 Recent Transactions (${data.total} total)</strong>
                            <table class="data-table">
                                <tr>
                                    <th>Hash</th>
                                    <th>Block</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Value</th>
                                    <th>Status</th>
                                    <th>Event Type</th>
                                </tr>
                    `;
                    
                    data.transactions.forEach(tx => {
                        const shortHash = tx.tx_hash.substring(0, 10) + '...';
                        const shortFrom = tx.from_address.substring(0, 10) + '...';
                        const shortTo = tx.to_address.substring(0, 10) + '...';
                        
                        tableHTML += `
                            <tr>
                                <td title="${tx.tx_hash}">${shortHash}</td>
                                <td>${tx.block_number}</td>
                                <td title="${tx.from_address}">${shortFrom}</td>
                                <td title="${tx.to_address}">${shortTo}</td>
                                <td>${tx.value} ETH</td>
                                <td>${tx.status}</td>
                                <td>${tx.event_type}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</table></div>';
                    txDiv.innerHTML = tableHTML;
                } else {
                    txDiv.innerHTML = '<div class="status error">No transactions found</div>';
                }
            } catch (error) {
                txDiv.innerHTML = `<div class="status error">❌ Failed to load transactions: ${error.message}</div>`;
            }
        }
        
        // 加载事件数据
        async function loadEventsData() {
            const eventsDiv = document.getElementById('events-data');
            eventsDiv.innerHTML = '<div class="loading">Loading events data...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/blockchain/events?limit=10`);
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    let tableHTML = `
                        <div class="status success">
                            <strong>📋 Contract Events (${data.total} total)</strong>
                            <table class="data-table">
                                <tr>
                                    <th>Event Name</th>
                                    <th>Block</th>
                                    <th>Contract</th>
                                    <th>Transaction</th>
                                    <th>Parameters</th>
                                </tr>
                    `;
                    
                    data.events.forEach(event => {
                        const shortContract = event.contract_address.substring(0, 10) + '...';
                        const shortTx = event.tx_hash.substring(0, 10) + '...';
                        const params = JSON.stringify(event.parameters || {});
                        
                        tableHTML += `
                            <tr>
                                <td>${event.event_name}</td>
                                <td>${event.block_number}</td>
                                <td title="${event.contract_address}">${shortContract}</td>
                                <td title="${event.tx_hash}">${shortTx}</td>
                                <td>${params}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</table></div>';
                    eventsDiv.innerHTML = tableHTML;
                } else {
                    eventsDiv.innerHTML = '<div class="status success">No contract events found (this is normal if no smart contract interactions have occurred)</div>';
                }
            } catch (error) {
                eventsDiv.innerHTML = `<div class="status error">❌ Failed to load events: ${error.message}</div>`;
            }
        }
        
        // 页面加载时自动执行
        window.onload = function() {
            checkBackendStatus();
            loadBlockchainStats();
            loadBlocksData();
            loadTransactionsData();
            loadEventsData();
        };
    </script>
</body>
</html>